<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"
    />
    <!--CSS-->
    <link href="/src/output.css" rel="stylesheet" />

    <!--fonts-->
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Cal+Sans&family=Lexend:wght@100..900&display=swap"
      rel="stylesheet"
    />

    <!--icons-->
    <link
      rel="stylesheet"
      href="https://cdn-uicons.flaticon.com/3.0.0/uicons-regular-rounded/css/uicons-regular-rounded.css"
    />
    <link
      rel="stylesheet"
      href="https://cdn-uicons.flaticon.com/3.0.0/uicons-bold-rounded/css/uicons-bold-rounded.css"
    />
    <link
      rel="stylesheet"
      href="https://cdn-uicons.flaticon.com/3.0.0/uicons-solid-rounded/css/uicons-solid-rounded.css"
    />
    <title>DraftQueen</title>
    <!-- Supabase JS -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  </head>
  <body class="min-h-screen bg-neutral-100 font-lexend">
    <div class="flex flex-col">
      <!--top nav (matches other pages) -->
      <div class="flex flex-row md:h-24 h-14 border-b-1 border-b-neutral-100">
        <!--logo-->
        <div
          class="bg-neutral-900 md:border-r-1 border-r-0 border-r-neutral-100 md:w-55 w-full px-9 md:px-0 flex items-center"
        >
          <a
            href="/pages/leagues.html"
            class="md:w-55 text-transparent bg-clip-text bg-linear-to-b from-white to-zinc-200 flex flex-row items-center md:text-4xl text-2xl font-calsans gap-1 md:justify-center h-full"
            >Draft<i
              class="fi fi-br-crown pt-1 md:text-2xl text-sm text-palepink rotate-30"
            ></i
          ></a>
          <!--mobile notifications (dropdown) -->
          <div class="ml-auto mr-3 md:hidden">
            <details id="mobileNoteBtn" class="dropdown dropdown-end">
              <summary
                class="btn btn-ghost rounded-full hover:bg-transparent hover:shadow-none text-white aspect-square size-9 flex items-center justify-center border-lightgray-border border-1 relative"
              >
                <i class="fi fi-sr-bell pt-1"></i>
                <span
                  id="mobileNotesBadge"
                  class="absolute bg-palepink rounded-full min-w-4 h-4 px-1 flex items-center justify-center text-[10px] -top-1 -right-1 hidden"
                ></span>
              </summary>
              <div
                class="menu dropdown-content z-10 shadow-sm w-72 p-3 bg-lightgray rounded-xl mt-2 text-white space-y-1 font-semibold"
              >
                <div class="text-xs text-neutral-300 px-1 pb-1">
                  Notifications
                </div>
                <ul id="mobileNotesList" class="space-y-1">
                  <li
                    class="text-xs text-neutral-400 px-2 py-2 rounded-lg bg-[rgba(255,255,255,0.04)]"
                  >
                    No notifications
                  </li>
                </ul>
              </div>
            </details>
          </div>
          <!--mobile menu-->
          <details class="dropdown dropdown-end">
            <summary
              class="btn btn-ghost rounded-full hover:bg-transparent hover:shadow-none text-white aspect-square size-9 flex md:hidden items-center justify-center border-lightgray-border border-1"
            >
              <i class="fi fi-sr-menu-burger pt-1 text-xs"></i>
            </summary>
            <ul
              class="menu dropdown-content top-menu-1 z-1 shadow-sm w-auto p-3 bg-lightgray rounded-xl mt-2 text-white space-y-1 font-semibold items-end"
            >
              <li>
                <a href="/pages/leagues.html" class="text-nowrap">My Leagues</a>
              </li>
              <li><a href="/pages/Challenges.html">Challenges</a></li>
              <li><a href="/pages/profile.html">My Profile</a></li>
            </ul>
          </details>
        </div>
        <!--menus-->
        <div class="flex-col flex-grow w-full hidden md:flex">
          <div
            class="bg-lightgray h-1/2 w-full flex flex-row items-center px-14"
          >
            <div class="flex-grow">
              <label
                class="input text-gray-400 bg-transparent hover:bg-lightgray-hover transition-colors focus:bg-transparent focus:border-1 focus:border-lightgray-border border-0 rounded-full h-8 shadow-none"
              >
                <i class="fi fi-br-search pt-1 text-sm"></i>
                <input type="text" placeholder="Search..." />
              </label>
            </div>
            <div class="flex gap-4">
              <details id="webNoteBtn" class="dropdown dropdown-end">
                <summary
                  class="btn btn-circle btn-ghost size-8 text-white border-1 border-lightgray-border relative"
                >
                  <i class="fi fi-sr-bell pt-1"></i>
                  <span
                    id="webNotesBadge"
                    class="absolute -top-1 -right-1 bg-neutral-900 text-white rounded-full min-w-4 h-4 px-1 flex items-center justify-center text-[10px] hidden"
                  ></span>
                </summary>
                <div
                  class="menu dropdown-content z-10 shadow-sm w-80 p-3 bg-white text-neutral-900 rounded-xl mt-2 space-y-1 font-semibold"
                >
                  <div class="text-xs text-neutral-500 px-1 pb-1">
                    Notifications
                  </div>
                  <ul id="webNotesList" class="space-y-1">
                    <li
                      class="text-xs text-neutral-500 px-2 py-2 rounded-lg bg-neutral-50"
                    >
                      No notifications
                    </li>
                  </ul>
                </div>
              </details>
              <div class="avatar">
                <div class="w-8 rounded-full ring-1 ring-white">
                  <img
                    src="https://img.daisyui.com/images/profile/demo/gordon@192.webp"
                  />
                </div>
              </div>
            </div>
          </div>
          <div class="bg-neutral-900 h-1/2 w-full px-14 flex justify-start">
            <ul
              class="menu menu-horizontal text-sm text-white space-x-10 font-semibold top-menu-1"
            >
              <li class="top-menu-1-active">
                <a href="/pages/leagues.html" data-keep-league>My Leagues</a>
              </li>
              <li>
                <a href="/pages/Challenges.html" data-keep-league>Challenges</a>
              </li>
              <li>
                <a href="/pages/profile.html" data-keep-league>My Profile</a>
              </li>
            </ul>
          </div>
        </div>
      </div>

      <!--ticker: league subnav-->
      <div
        class="h-12 border-b-[1.5px] border-b-neutral-900 md:px-14 px-10 flex items-center justify-between"
      >
        <!--left: league id breadcrumb-->
        <div class="flex items-center gap-3 text-xs">
          <a
            href="/pages/leagues.html"
            class="text-neutral-500 hover:text-neutral-700"
            >Leagues</a
          >
          <span class="text-neutral-300">/</span>
          <span id="roLeagueNameCrumb" class="font-semibold text-neutral-900"
            >League Name</span
          >
        </div>
        <!--right: subnav tabs-->
        <div class="hidden md:flex">
          <ul
            class="menu menu-horizontal text-xs font-semibold space-x-2 top-menu-1 filters"
          >
            <li>
              <a href="/pages/overview.html" data-keep-league>Overview</a>
            </li>
            <li>
              <a
                href="/pages/roster.html"
                class="filters-active"
                data-keep-league
                >My Roster</a
              >
            </li>
            <li>
              <a href="/pages/scoreboard.html" data-keep-league>Scoreboard</a>
            </li>
          </ul>
        </div>
        <!--mobile subnav-->
        <div class="md:hidden">
          <select id="pageSelector" class="select rounded-full h-8 text-xs">
            <option id="pageOverview">Overview</option>
            <option id="pageMyRoster" selected>My Roster</option>
            <option id="pageScoreboard">Scoreboard</option>
          </select>
        </div>
      </div>

      <!--body-->
      <div class="md:mx-14 mx-10 my-10">
        <!-- league header -->
        <div
          class="flex flex-col md:flex-row md:items-end md:justify-between gap-6"
        >
          <div>
            <h1 id="roFranchise" class="font-semibold text-sm">Franchise</h1>
            <h2 id="roSeason" class="text-5xl font-bold">Season</h2>
            <p class="text-neutral-500 text-xs mt-2">
              League:
              <span
                id="roLeagueNameHeader"
                class="font-semibold text-neutral-900"
                >League Name</span
              >
            </p>
          </div>
          <!-- actions -->
          <div class="md:flex hidden items-center gap-3 md:gap-4">
            <a
              href="/pages/trade.html"
              data-keep-league
              class="bg-neutral-900 text-white rounded-full h-9 px-4 text-xs font-semibold flex items-center gap-2"
              ><i class="fi fi-rr-exchange pt-[2px]"></i> Start a trade</a
            >
          </div>
        </div>

        <!-- roster grid -->
        <div class="mt-6">
          <h3 class="text-lg font-semibold text-neutral-900">Your Roster</h3>

          <div
            class="grid md:grid-cols-4 sm:grid-cols-2 grid-cols-1 gap-6 mt-4"
          >
            <ul id="roGrid" class="contents"></ul>

            <!-- card template (hidden) -->
            <template id="roCardTpl">
              <a
                href="#"
                class="group rounded-3xl border-1 border-neutral-100 bg-white p-5 flex items-center gap-4 hover:border-neutral-200"
              >
                <div class="avatar">
                  <div class="w-12 h-12 rounded-full ring-1 ring-neutral-200">
                    <img src="" alt="" />
                  </div>
                </div>
                <div class="min-w-0 flex-1">
                  <p class="font-semibold truncate"></p>
                </div>
                <div class="text-right">
                  <p class="text-xs text-neutral-500">Points</p>
                  <p class="text-2xl font-bold leading-none"></p>
                </div>
              </a>
            </template>

            <!-- skeleton placeholders -->
            <div id="roPlaceholders" class="contents">
              <div
                class="rounded-3xl border-1 border-neutral-100 bg-white p-5 flex items-center gap-4"
              >
                <div class="skeleton w-12 h-12 rounded-full"></div>
                <div class="flex-1 space-y-2">
                  <div class="skeleton h-4 w-36 rounded-full"></div>
                  <div class="skeleton h-3 w-20 rounded-full"></div>
                </div>
                <div class="skeleton h-6 w-10"></div>
              </div>
              <div
                class="rounded-3xl border-1 border-neutral-100 bg-white p-5 flex items-center gap-4"
              >
                <div class="skeleton w-12 h-12 rounded-full"></div>
                <div class="flex-1 space-y-2">
                  <div class="skeleton h-4 w-36 rounded-full"></div>
                  <div class="skeleton h-3 w-20 rounded-full"></div>
                </div>
                <div class="skeleton h-6 w-10"></div>
              </div>
              <div
                class="rounded-3xl border-1 border-neutral-100 bg-white p-5 flex items-center gap-4"
              >
                <div class="skeleton w-12 h-12 rounded-full"></div>
                <div class="flex-1 space-y-2">
                  <div class="skeleton h-4 w-36 rounded-full"></div>
                  <div class="skeleton h-3 w-20 rounded-full"></div>
                </div>
                <div class="skeleton h-6 w-10"></div>
              </div>
            </div>
          </div>

          <!-- mobile trade CTA -->
          <div class="mt-8 md:hidden">
            <a
              href="/pages/trade.html"
              data-keep-league
              class="btn w-full h-12 rounded-xl bg-neutral-900 text-white border-0"
              >Start a trade</a
            >
          </div>
        </div>
      </div>
    </div>
    <script>
      (function () {
        const $ = (id) => document.getElementById(id);
        const elCrumb = $("roLeagueNameCrumb");
        const elHdr = $("roLeagueNameHeader");
        const elFr = $("roFranchise");
        const elSe = $("roSeason");
        const grid = $("roGrid");
        const tpl = $("roCardTpl");
        const ph = $("roPlaceholders");
        const pageSelector = document.getElementById("pageSelector");
        let supabaseClient = null;

        function setText(el, t) {
          if (el) el.textContent = t;
        }
        function showPH(show) {
          if (ph) ph.style.display = show ? "" : "none";
        }

        async function loadSupabase() {
          if (supabaseClient) return supabaseClient;
          const res = await fetch("/supabase.txt", { cache: "no-store" });
          if (!res.ok) throw new Error("Failed to load supabase.txt");
          const text = await res.text();
          const map = Object.fromEntries(
            text
              .split(/\n+/)
              .map((l) => l.trim())
              .filter(Boolean)
              .map((line) => {
                const i = line.indexOf("=");
                return [line.slice(0, i).trim(), line.slice(i + 1).trim()];
              })
          );
          const url =
            map["SUPABASE_URL"] ||
            map["SUPABASE_PROJECT_URL"] ||
            (map["SUPABASE_PROJECT_ID"]
              ? `https://${map["SUPABASE_PROJECT_ID"]}.supabase.co`
              : "");
          const key =
            map["SUPABASE_ANON_KEY"] ||
            map["PUBLIC_ANON_KEY"] ||
            map["SUPABASE_PUBLIC_KEY"];
          if (!url || !key) throw new Error("Supabase URL/key missing");
          supabaseClient = window.supabase.createClient(url, key);
          // expose globally for notifications dropdowns
          window.supabaseClient = supabaseClient;
          return supabaseClient;
        }

        async function requireSession() {
          const { data } = await supabaseClient.auth.getSession();
          if (!data?.session) {
            const ret = encodeURIComponent(
              "/pages/roster.html" + location.search
            );
            location.assign(`/pages/auth.html?returnTo=${ret}`);
            return null;
          }
          return data.session;
        }

        function getLeagueId() {
          return (
            (window.getCurrentLeagueId && window.getCurrentLeagueId()) ||
            new URLSearchParams(location.search).get("league")
          );
        }

        async function fetchLeague(leagueId) {
          const { data, error } = await supabaseClient
            .from("leagues")
            .select(
              "id, name, season:seasons(id, season_number, franchise:franchises(name))"
            )
            .eq("id", leagueId)
            .maybeSingle();
          if (error) throw error;
          return data;
        }

        async function fetchContestants(ids) {
          if (!ids || !ids.length) return [];
          const { data, error } = await supabaseClient
            .from("contestants")
            .select("id, stage_name, avatar_url")
            .in("id", ids);
          if (error) throw error;
          return data || [];
        }

        // Exact roster source per schema: v_member_roster_points
        // Returns one row per contestant on the member's active roster with points earned while on roster
        async function fetchMyRoster(leagueId, userId) {
          const { data, error } = await supabaseClient
            .from("v_member_roster_points")
            .select("contestant_id, points_while_on_roster")
            .eq("league_id", leagueId)
            .eq("user_id", userId)
            .order("points_while_on_roster", { ascending: false });

          if (error) throw error;
          return (data || []).map((r) => ({
            contestant_id: r.contestant_id,
            points: r.points_while_on_roster ?? 0,
          }));
        }

        function renderRoster(items, contestantsById, leagueId) {
          if (!grid || !tpl) return;
          grid.innerHTML = "";
          for (const it of items) {
            const c = contestantsById.get(it.contestant_id);
            const node = tpl.content.firstElementChild.cloneNode(true);
            const a = node;
            const img = node.querySelector("img");
            const name = node.querySelector("p.font-semibold");
            const pts = node.querySelector("div.text-right > p.text-2xl");
            if (a) {
              const url = new URL("/pages/queen-details.html", location.origin);
              url.searchParams.set("queen", it.contestant_id);
              if (leagueId) url.searchParams.set("league", leagueId);
              a.href = url.pathname + "?" + url.searchParams.toString();
              a.setAttribute("data-keep-league", "");
            }
            if (img)
              img.src =
                c?.avatar_url ||
                "https://img.daisyui.com/images/profile/demo/2@94.webp";
            if (img) img.alt = c?.stage_name || "Contestant";
            if (name) name.textContent = c?.stage_name || "Unknown";
            if (pts) pts.textContent = it.points ?? 0;
            grid.appendChild(node);
          }
        }

        (async () => {
          try {
            await loadSupabase();
            const session = await requireSession();
            if (!session) return;
            const leagueId = getLeagueId();
            if (!leagueId) return;

            // Header
            const lg = await fetchLeague(leagueId);
            if (lg) {
              setText(elCrumb, lg.name || "League");
              setText(elHdr, lg.name || "League");
              setText(elFr, lg.season?.franchise?.name || "Franchise");
              setText(
                elSe,
                lg.season?.season_number
                  ? `Season ${lg.season.season_number}`
                  : "Season"
              );
            }

            showPH(true);
            // Roster
            const items = await fetchMyRoster(leagueId, session.user.id);
            if (!items.length) {
              showPH(false);
              // Optionally, show an empty-state card
              const empty = document.createElement("div");
              empty.className =
                "rounded-3xl border-1 border-neutral-100 bg-white p-5 text-sm text-neutral-500";
              empty.textContent = "No queens on your roster yet.";
              grid.appendChild(empty);
              return;
            }
            const ids = items.map((i) => i.contestant_id);
            const contestants = await fetchContestants(ids);
            const mapById = new Map(contestants.map((c) => [c.id, c]));
            renderRoster(items, mapById, leagueId);
            showPH(false);

            // Mobile selector routing (preserve ?league)
            function gotoLeaguePage(path) {
              const url = new URL(path, location.origin);
              if (leagueId) url.searchParams.set("league", leagueId);
              location.assign(url.pathname + "?" + url.searchParams.toString());
            }
            if (pageSelector) {
              pageSelector.addEventListener("change", () => {
                const sel = pageSelector.options[pageSelector.selectedIndex];
                switch (sel?.id) {
                  case "pageOverview":
                    gotoLeaguePage("/pages/overview.html");
                    break;
                  case "pageMyRoster":
                    gotoLeaguePage("/pages/roster.html");
                    break;
                  case "pageScoreboard":
                    gotoLeaguePage("/pages/scoreboard.html");
                    break;
                }
              });
            }
          } catch (e) {
            console.error(e);
            showPH(false);
          }
        })();
      })();
      // --- Notifications dropdown wiring (mobile + desktop) ---
      const mobileNotesDetails = document.getElementById("mobileNoteBtn");
      const mobileNotesList = document.getElementById("mobileNotesList");
      const mobileNotesBadge = document.getElementById("mobileNotesBadge");

      const webNotesDetails = document.getElementById("webNoteBtn");
      const webNotesList = document.getElementById("webNotesList");
      const webNotesBadge = document.getElementById("webNotesBadge");

      function getSupabase() {
        return window.supabaseClient || null;
      }

      function fmtSince(ts) {
        try {
          const d = new Date(ts);
          const diff = (Date.now() - d.getTime()) / 1000;
          if (diff < 60) return `${Math.floor(diff)}s`;
          if (diff < 3600) return `${Math.floor(diff / 60)}m`;
          if (diff < 86400) return `${Math.floor(diff / 3600)}h`;
          return `${Math.floor(diff / 86400)}d`;
        } catch {
          return "";
        }
      }

      async function fetchNotifications(userId) {
        const sb = getSupabase();
        if (!sb) return [];
        const candidates = [
          {
            table: "v_user_notifications",
            cols: "id, title, created_at, is_read, href",
          },
          {
            table: "notifications",
            cols: "id, title, created_at, is_read, href",
          },
        ];
        for (const t of candidates) {
          try {
            const { data, error } = await sb
              .from(t.table)
              .select(t.cols)
              .eq("user_id", userId)
              .order("created_at", { ascending: false })
              .limit(20);
            if (!error && data) return data;
          } catch {}
        }
        return [];
      }

      function renderMobileNotifications(rows) {
        if (!mobileNotesList) return;
        mobileNotesList.innerHTML = "";
        if (!rows.length) {
          const li = document.createElement("li");
          li.className =
            "text-xs text-neutral-400 px-2 py-2 rounded-lg bg-[rgba(255,255,255,0.04)]";
          li.textContent = "No notifications";
          mobileNotesList.appendChild(li);
          if (mobileNotesBadge) mobileNotesBadge.classList.add("hidden");
          return;
        }
        let unread = 0;
        for (const n of rows) {
          if (n.is_read === false) unread++;
          const a = document.createElement("a");
          a.className =
            "flex items-start gap-2 px-2 py-2 rounded-lg hover:bg-[rgba(255,255,255,0.06)] text-xs";
          a.href = n.href || "#";
          a.innerHTML = `
      <span class="mt-0.5"><i class="fi fi-rr-bolt"></i></span>
      <span class="flex-1 min-w-0">
        <span class="block text-white truncate">${
          n.title || "Notification"
        }</span>
        <span class="block text-[10px] text-neutral-300">${fmtSince(
          n.created_at
        )}</span>
      </span>`;
          const li = document.createElement("li");
          li.appendChild(a);
          mobileNotesList.appendChild(li);
        }
        if (mobileNotesBadge) {
          if (unread > 0) {
            mobileNotesBadge.textContent = String(unread);
            mobileNotesBadge.classList.remove("hidden");
          } else {
            mobileNotesBadge.classList.add("hidden");
          }
        }
      }

      function renderWebNotifications(rows) {
        if (!webNotesList) return;
        webNotesList.innerHTML = "";
        if (!rows.length) {
          const li = document.createElement("li");
          li.className =
            "text-xs text-neutral-500 px-2 py-2 rounded-lg bg-neutral-50";
          li.textContent = "No notifications";
          webNotesList.appendChild(li);
          if (webNotesBadge) webNotesBadge.classList.add("hidden");
          return;
        }
        let unread = 0;
        for (const n of rows) {
          if (n.is_read === false) unread++;
          const a = document.createElement("a");
          a.className =
            "flex items-start gap-2 px-2 py-2 rounded-lg hover:bg-neutral-50 text-xs";
          a.href = n.href || "#";
          a.innerHTML = `
      <span class="mt-0.5"><i class="fi fi-rr-bolt"></i></span>
      <span class="flex-1 min-w-0">
        <span class="block text-neutral-900 truncate">${
          n.title || "Notification"
        }</span>
        <span class="block text-[10px] text-neutral-500">${fmtSince(
          n.created_at
        )}</span>
      </span>`;
          const li = document.createElement("li");
          li.appendChild(a);
          webNotesList.appendChild(li);
        }
        if (webNotesBadge) {
          if (unread > 0) {
            webNotesBadge.textContent = String(unread);
            webNotesBadge.classList.remove("hidden");
          } else {
            webNotesBadge.classList.add("hidden");
          }
        }
      }

      async function refreshNotifications() {
        try {
          const sb = getSupabase();
          if (!sb) {
            setTimeout(refreshNotifications, 300);
            return;
          }
          const { data: sess } = await sb.auth.getSession();
          const userId = sess?.session?.user?.id;
          if (!userId) {
            renderMobileNotifications([]);
            renderWebNotifications([]);
            return;
          }
          const rows = await fetchNotifications(userId);
          renderMobileNotifications(rows || []);
          renderWebNotifications(rows || []);
        } catch {
          renderMobileNotifications([]);
          renderWebNotifications([]);
        }
      }

      if (mobileNotesDetails) {
        let loadedOnce = false;
        mobileNotesDetails.addEventListener("toggle", async () => {
          if (mobileNotesDetails.open && !loadedOnce) {
            await refreshNotifications();
            loadedOnce = true;
          }
        });
        setTimeout(refreshNotifications, 800);
      }
      if (webNotesDetails) {
        let loadedOnceWeb = false;
        webNotesDetails.addEventListener("toggle", async () => {
          if (webNotesDetails.open && !loadedOnceWeb) {
            await refreshNotifications();
            loadedOnceWeb = true;
          }
        });
        setTimeout(refreshNotifications, 900);
      }
    </script>
    <script src="/src/js/league-context.js"></script>
  </body>
</html>
